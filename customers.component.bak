import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { CustomerService, Customer, CreateCustomer } from './services/customer.service';
import { Subject } from 'rxjs';
import { finalize, takeUntil } from 'rxjs/operators';

@Component({
  standalone: true,
  selector: 'app-customers',
  imports: [CommonModule, FormsModule],
  template: `
    <div class="container">
      <h1>Customer CRUD (SSR → Private API)</h1>

      <section class="card">
        <h2>Create customer</h2>
        <div class="grid">
          <input placeholder="First name" [(ngModel)]="model.firstName" />
          <input placeholder="Last name" [(ngModel)]="model.lastName" />
          <input placeholder="Email" [(ngModel)]="model.email" />
          <input placeholder="Phone (optional)" [(ngModel)]="model.phone" />
        </div>
        <button (click)="create()" [disabled]="saving">Create</button>
        <span class="hint" *ngIf="error">{{ error }}</span>
      </section>

      <section class="card">
        <h2>Customers</h2>
        <button (click)="load()" [disabled]="loading">Refresh</button>

        <p *ngIf="loading">Loading…</p>

        <table *ngIf="!loading" class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of customers">
              <td>{{ c.firstName }} {{ c.lastName }}</td>
              <td>{{ c.email }}</td>
              <td>{{ c.phone || '-' }}</td>
              <td>
                <button class="danger" (click)="remove(c._id)" [disabled]="deletingId===c._id">
                  Delete
                </button>
              </td>
            </tr>
            <tr *ngIf="customers.length === 0">
              <td colspan="4">No customers yet.</td>
            </tr>
          </tbody>
        </table>
      </section>

      <p class="footer">
        Browser calls <code>/internal-api</code> only. API stays ClusterIP.
      </p>
    </div>
  `,
  styles: [`
    .container { max-width: 900px; margin: 24px auto; padding: 0 16px; font-family: system-ui, Arial; }
    h1 { margin-bottom: 16px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 16px 0; }
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; margin: 10px 0 12px; }
    input { padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 10px 14px; border: 1px solid #aaa; border-radius: 8px; cursor: pointer; background: white; }
    button.danger { border-color: #c44; }
    .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .table th, .table td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; }
    .hint { margin-left: 10px; color: #b00; }
    .footer { margin-top: 18px; color: #666; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
  `]
})
export class CustomersComponent {
  private api = inject(CustomerService);
  private cancelLoad$ = new Subject<void>();
  customers: Customer[] = [];
  loading = false;
  saving = false;
  deletingId: string | null = null;
  error = '';

  model: CreateCustomer = { firstName: '', lastName: '', email: '', phone: '' };

  ngOnInit() {
    this.load();
  }

load() {
  // cancel any in-flight load (prevents a hung request from keeping loading=true)
  this.cancelLoad$.next();

  this.loading = true;
  this.error = '';

  this.api.list()
    .pipe(
      takeUntil(this.cancelLoad$),
      finalize(() => {
        this.loading = false;
      })
    )
    .subscribe({
      next: (data) => {
        this.customers = data;
      },
      error: (e) => {
        this.error = 'Failed to load customers';
        console.error(e);
      }
    });
 }

  create() {
    if (!this.model.firstName || !this.model.lastName || !this.model.email) {
      this.error = 'First name, last name, and email are required.';
      return;
    }
    this.saving = true;
    this.error = '';
    const payload: CreateCustomer = {
      firstName: this.model.firstName.trim(),
      lastName: this.model.lastName.trim(),
      email: this.model.email.trim(),
      phone: (this.model.phone || '').trim() || undefined
    };

    this.api.create(payload).subscribe({
      next: () => {
        this.model = { firstName: '', lastName: '', email: '', phone: '' };
        this.saving = false;
        this.load();
      },
      error: (e) => { this.error = 'Failed to create customer'; this.saving = false; console.error(e); }
    });
  }

  remove(id: string) {
    this.deletingId = id;
    this.error = '';
    this.api.delete(id).subscribe({
      next: () => { this.deletingId = null; this.load(); },
      error: (e) => { this.error = 'Failed to delete customer'; this.deletingId = null; console.error(e); }
    });
  }

  ngOnDestroy() {
  this.cancelLoad$.next();
  this.cancelLoad$.complete();
 }

}